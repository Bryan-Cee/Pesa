name: Release

on:
  repository_dispatch:
    types: [eas-build-complete]

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.client_payload.status == 'finished'
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Download APK
        id: download
        run: |
          APK_NAME="pesa-v${{ github.event.client_payload.appVersion }}.apk"
          curl -f -L --max-time 600 -o "$APK_NAME" "${{ github.event.client_payload.buildUrl }}"

          # Verify file was downloaded and is not empty
          if [ ! -s "$APK_NAME" ]; then
            echo "::error::APK download failed or file is empty"
            exit 1
          fi

          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: notes
        run: |
          VERSION="v${{ github.event.client_payload.appVersion }}"
          PREV_TAG=$(git tag --sort=-v:refname | grep '^v' | sed -n '2p')

          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log --oneline "$PREV_TAG"..HEAD --no-merges | head -20)
          else
            COMMITS=$(git log --oneline -10 --no-merges)
          fi

          if [ -z "$COMMITS" ]; then
            COMMITS="No notable changes"
          fi

          cat > release_notes.md << EOF
          ## Pesa $VERSION

          **Platform:** ${{ github.event.client_payload.platform }}
          **Build Profile:** ${{ github.event.client_payload.buildProfile }}
          **Build ID:** \`${{ github.event.client_payload.buildId }}\`

          ### Changes
          $COMMITS
          EOF

      - name: Create GitHub Release
        run: |
          VERSION="v${{ github.event.client_payload.appVersion }}"

          # Delete existing release if it exists (allows re-runs)
          gh release delete "$VERSION" --yes 2>/dev/null || true

          gh release create "$VERSION" \
            "${{ steps.download.outputs.apk_name }}" \
            --title "Pesa $VERSION" \
            --notes-file release_notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
